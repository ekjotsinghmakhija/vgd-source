name: Release VGD macOS DMG

# This workflow builds a standalone macOS DMG for VGD.
# It does NOT require Apple Signing Certificates (results in an unsigned binary).

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-macos-dmg:
    runs-on: macos-14 # Uses Apple Silicon (M1/M2) runner for native performance
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Setup Python
        run: |
          uv python install
          uv sync --locked

      # Build the standalone executable folder using PyInstaller
      - name: Build VGD Binary
        run: uv run pyinstaller packaging/pyinstaller/vgd.spec

      # Create the DMG file manually using hdiutil (Apple's disk utility)
      - name: Create DMG
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          DMG_NAME="VGD-${VERSION}.dmg"

          # Prepare a folder for the DMG content
          mkdir -p dmg_root

          # Copy the built binary folder into the DMG root
          # Note: vgd.spec outputs to dist/vgd
          cp -r dist/vgd dmg_root/VGD

          # Create a symlink to Applications for easy install (optional for CLI, but standard for DMGs)
          ln -s /Applications dmg_root/Applications

          # Build the DMG
          hdiutil create -volname "VGD_Installer" -srcfolder dmg_root -ov -format UDZO "dist/$DMG_NAME"

          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV

      # Upload the DMG to the GitHub Release
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/${{ env.DMG_NAME }}
          draft: false
          prerelease: false
          generate_release_notes: true
