name: Release VGD macOS DMG

# This workflow builds a standalone macOS DMG for VGD.
# It includes the Dashboard and MacMon dependencies.

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-macos-dmg:
    runs-on: macos-14 # Uses Apple Silicon (M1/M2) runner
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Install System Dependencies (Required by vgd.spec)
      - name: Install MacMon
        run: brew install macmon

      # 2. Install UV and Python
      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Setup Python
        run: |
          uv python install
          uv sync --locked

      # 3. Build Dashboard (Required by vgd.spec)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Dashboard
        run: |
          cd dashboard
          npm ci
          npm run build
          cd ..

      # 4. Build Binary (Now that dashboard/build exists)
      - name: Build VGD Binary
        run: uv run pyinstaller packaging/pyinstaller/vgd.spec

      # 5. Create DMG
      - name: Create DMG
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          DMG_NAME="VGD-${VERSION}.dmg"

          mkdir -p dmg_root
          cp -r dist/vgd dmg_root/VGD
          ln -s /Applications dmg_root/Applications

          hdiutil create -volname "VGD_Installer" -srcfolder dmg_root -ov -format UDZO "dist/$DMG_NAME"

          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV

      # 6. Upload to Release
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/${{ env.DMG_NAME }}
          draft: false
          prerelease: false
          generate_release_notes: true
