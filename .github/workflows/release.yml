name: Release VGD

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  # ------------------------------------------------------------------
  # JOB 1: Build Python Wheel & Source Distribution (Runs on Linux)
  # ------------------------------------------------------------------
  build-python-artifacts:
    name: Build Python Package (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install

      - name: Build Dashboard
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: |
          if [ -d "dashboard" ]; then
            cd dashboard
            npm ci
            npm run build
          else
            echo "::warning::Dashboard directory not found, skipping build."
          fi

      - name: Build Wheel and Sdist
        run: uv build

      - name: Upload Artifacts
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*
          draft: false
          prerelease: false

  # ------------------------------------------------------------------
  # JOB 2: Build Standalone macOS App & DMG (Runs on macOS)
  # ------------------------------------------------------------------
  build-macos-app:
    name: Build macOS DMG
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        # Only install macmon, we use native hdiutil for DMG now
        run: brew install macmon

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python 3.12
        run: uv python install 3.12

      - name: Build Dashboard
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: |
          if [ -d "dashboard" ]; then
            cd dashboard
            npm ci
            npm run build
          fi

      - name: Install Python Dependencies
        run: |
          uv sync --group dev
          uv pip install pyinstaller

      # CRITICAL STEP: Robust Build Process
      - name: Generate Spec & Build App
        run: |
          # 1. Find the main entry point dynamically
          if [ -f "src/vgd/main.py" ]; then
            ENTRY_POINT="src/vgd/main.py"
            echo "Found entry point at src/vgd/main.py"
          elif [ -f "src/exo/main.py" ]; then
            ENTRY_POINT="src/exo/main.py"
            echo "Found entry point at src/exo/main.py"
          else
            echo "Error: Could not find main.py in src/vgd or src/exo"
            exit 1
          fi

          # 2. Generate Spec (Removed invalid flags --clean --noconfirm)
          uv run pyi-makespec --name "VGD" --windowed --onedir "$ENTRY_POINT"

          # 3. Run PyInstaller (Using correct flags here)
          uv run pyinstaller --clean --noconfirm VGD.spec

          # 4. Verify Output
          if [ -d "dist/VGD.app" ]; then
            echo "✅ Build Successful: dist/VGD.app created."
          else
            echo "❌ Build Failed: dist/VGD.app not found."
            ls -R dist/
            exit 1
          fi

      # BULLETPROOF DMG CREATION: Use native hdiutil (No external tools/AppleScript)
      - name: Create DMG using hdiutil
        run: |
          # 1. Prepare a staging folder
          mkdir -p dist/dmg_root
          cp -r "dist/VGD.app" dist/dmg_root/

          # 2. Create standard symlink to /Applications
          ln -s /Applications dist/dmg_root/Applications

          # 3. Build DMG
          hdiutil create -volname "VGD Installer" \
            -srcfolder dist/dmg_root \
            -ov -format UDZO \
            "dist/VGD-${{ github.ref_name }}-macos-arm64.dmg"

      - name: Upload DMG
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*.dmg
          draft: false
          prerelease: false
